<!doctype html>
<åhtml lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filmkväll – tur & poäng</title>
  <style>
    :root{
      --bg:#0f1116; --panel:#161a22; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#f6c247; --accent-weak:#ffe399; --ok:#2ea86b; --err:#e5534b;
      --input:#0f1116; --border:#2a3140; --btn:#1f2533; --btn-text:#e6e8ee;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px;}
    h1{font-size:26px; margin:0 0 8px;}
    h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:14px 0;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .col{flex:1 1 220px; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px;}
    input, select, button, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none;
    }
    input::placeholder{color:#7b8597}
    button{
      background:var(--btn); color:var(--btn-text); cursor:pointer; border:1px solid var(--border);
      padding:8px 12px; border-radius:9px; font-size:14px;
    }
    .primary{background:var(--accent); color:#1b1f2a; border-color:#c8a73a}
    .ghost{background:transparent}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:#1e2431; border:1px solid var(--border)}
    .grid5{display:grid; grid-template-columns:repeat(5,1fr); gap:12px}
    .right{margin-left:auto}
    .sep{height:1px; background:var(--border); margin:14px 0}
    .tight{margin-top:6px; margin-bottom:6px}
    .note{font-size:13px; color:var(--muted); margin-top:6px}
    .flash{animation:flash 700ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(246,194,71,.0)}40%{box-shadow:0 0 0 6px rgba(246,194,71,.25)}100%{box-shadow:0 0 0 0 rgba(246,194,71,.0)}}
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --panel:#ffffff; --text:#151823; --muted:#5b6475;
        --accent:#f6c247; --accent-weak:#ffe399; --input:#ffffff; --border:#dfe3ee; --btn:#eef0f6; --btn-text:#111826;
      }
      input,select,textarea{box-shadow:0 0 0 1px var(--border) inset}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Filmkväll – tur & poäng</h1>
    <p class="muted">Välj vem du är, spara lösenord, uppdatera din lista och sätt poäng.</p>

    <!-- Inställningar -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Jag är</label>
          <select id="who"></select>
        </div>
        <div class="col">
          <label>Tema</label>
          <select id="theme">
            <option value="auto">Auto</option>
            <option value="dark">Mörkt</option>
            <option value="light">Ljust</option>
          </select>
        </div>
        <div class="col">
          <label>Färg</label>
          <select id="accent">
            <option value="gul">Gul</option>
            <option value="blå">Blå</option>
            <option value="grön">Grön</option>
            <option value="röd">Röd</option>
          </select>
        </div>
      </div>

      <div class="toolbar tight">
        <div class="col" style="flex:1 1 320px; min-width:280px">
          <label>Lösenord</label>
          <input id="pw" type="password" placeholder="Look4fun" />
        </div>
        <button id="togglePw" class="ghost">Visa</button>
        <button id="savePw" class="ghost">Spara lösenord</button>
        <div id="apiStatus" class="pill right">Init…</div>
      </div>
    </div>

    <!-- På tur nu -->
    <div class="card" id="nowCard">
      <h3>På tur nu</h3>

      <div class="row">
        <div class="col">
          <label>Nästa i tur</label>
          <input id="nextName" type="text" readonly>
        </div>
        <div class="col">
          <label>Film (förslag från #1 i listan)</label>
          <input id="suggested" type="text" readonly>
        </div>
      </div>

      <!-- Poängrad (OVANFÖR knappar) -->
      <div class="row" id="scoresRow">
        <div class="col"><label>Hannah</label><input id="s-Hannah" placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Maria</label><input id="s-Maria"  placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Tuva</label><input id="s-Tuva"   placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Alva</label><input id="s-Alva"   placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Lars</label><input id="s-Lars"   placeholder="–" inputmode="decimal"></div>
      </div>

      <div class="toolbar tight">
        <button id="refreshScores" class="ghost">Uppdatera poäng</button>
        <button id="saveAllScores" class="primary">Spara poäng</button>
        <span class="right"></span>
        <button id="skip" class="ghost">Hoppa över</button>
      </div>

      <div class="row">
        <div class="col">
          <label>Kommentar</label>
          <input id="comment" placeholder="valfritt">
        </div>
        <div class="col" style="align-self:end">
          <button id="saveNight" class="primary">Spara kväll</button>
        </div>
      </div>
    </div>

    <!-- Min lista -->
    <div class="card">
      <h3>Mina kommande (1–5)</h3>
      <div class="grid5">
        <input id="w1" placeholder="#1 – högst upp">
        <input id="w2" placeholder="#2">
        <input id="w3" placeholder="#3">
        <input id="w4" placeholder="#4">
        <input id="w5" placeholder="#5">
      </div>
      <div class="toolbar tight">
        <button id="loadList" class="ghost">Hämta min lista</button>
        <button id="saveList" class="primary">Spara min lista</button>
      </div>
      <p class="note">När kvällen sparas för den som är på tur flyttas #2–#5 upp (och #1 tas bort).</p>
    </div>

    <!-- Topplistor -->
    <div class="card">
      <h3>Topplistor (topp 5)</h3>
      <div id="tops"></div>
    </div>

    <!-- Historik -->
    <div class="card">
      <h3>Historik (senaste 10)</h3>
      <div id="history"></div>
    </div>
  </div>

<script>
/* ===== KONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbzoyrM9jj8lOy-pTmcR4iCWtIL3-YJ2IDLZ5pVV9wgrIMepCBJ_d_F8CARhqGZdnCoWAA/exec';
const PEOPLE = ['Hannah','Maria','Tuva','Alva','Lars'];
const LS_PW = 'film_pw';

/* ===== Hjälpare ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const getPw = ()=> 'Look4fun';
const setPw = (v)=>{ $('#pw').value=v; localStorage.setItem(LS_PW,v); };
const qs = (o)=> new URLSearchParams(o).toString();
const api = (action, params={}) => fetch(`${API}?${qs({action, pw:getPw(), ...params})}`, {cache:'no-store'}).then(r=>r.json());
const round1 = (x)=>Math.round((Number(x)||0)*10)/10;
const setStatus=(ok,msg)=>{ const el=$('#apiStatus'); el.textContent=(ok?'OK – ':'Fel – ')+msg; el.className=ok?'ok':'err'; };

/* ===== Tema/accent (behåller dina selecter) ===== */
function applyTheme(){
  const t = $('#theme').value;
  document.documentElement.style.colorScheme = (t==='light')?'light':(t==='dark'?'dark':'normal');
}
function applyAccent(){
  const a = $('#accent').value;
  const r = document.documentElement;
  const map = {
    'gul' : ['#f6c247','#ffe399'],
    'blå' : ['#59a5ff','#b9d8ff'],
    'grön': ['#59d38b','#b9f2d3'],
    'röd' : ['#ff8aa0','#ffd0da']
  };
  const [a1,a2]=map[a]||map['gul'];
  r.style.setProperty('--accent',a1); r.style.setProperty('--accent-weak',a2);
}

/* ===== Ladda hel sida ===== */
async function loadAll(){
  try{
    // current + scores
    const cur = await api('getCurrent');
    if(!cur.ok) return setStatus(false,cur.error||'getCurrent');
    $('#nextName').value  = cur.next || '';
    $('#suggested').value = cur.suggestion || '';
    if (cur.scores){
      for (const p of PEOPLE){ const el = document.getElementById(`s-${p}`); if(el) el.value = cur.scores[p] ?? ''; }
    }
    // min lista
    await loadMyList();
    // toppar (topp 5)
    const tops = await api('getTops',{limit:5});
    if (tops.ok){
      const films = (tops.bestFilms||[]).map(x=>`<div class="pill" style="display:block;margin:6px 0">${x.film} — <strong>${x.avg}</strong> <span class="muted">(${x.who})</span></div>`).join('') || '–';
      const pickers = (tops.bestPickers||[]).map(x=>`<div class="pill" style="display:block;margin:6px 0">${x.who} — <strong>${x.avg}</strong> <span class="muted">(${x.n} filmer)</span></div>`).join('') || '–';
      $('#tops').innerHTML = `<div class="row"><div class="col"><label>Bästa filmer</label>${films}</div><div class="col"><label>Bästa väljare</label>${pickers}</div></div>`;
    }
    // historik (senaste 10, inkl snitt & per person)
    const hist = await api('getHistory',{limit:10});
    if (hist.ok){
      const rows = (hist.rows||[]).map(r=>{
        const nums = PEOPLE.map(p=>Number(r[p])||0).filter(x=>x>0);
        const avg = nums.length? round1(nums.reduce((a,b)=>a+b,0)/nums.length) : '-';
        const per = PEOPLE.map(p=>`${p}: ${r[p]||'-'}`).join(' • ');
        return `<div class="pill" style="display:block;margin:6px 0;padding:10px 12px">
          <strong>${r['Film']||'–'}</strong> — ${r['Datum']||''}
          <span class="muted"> (val: ${r['Vem valde']||'-'}, Snitt: ${avg})</span><br/><span class="muted">${per}</span>
        </div>`;
      }).join('');
      $('#history').innerHTML = rows || 'Tomt.';
    }
    setStatus(true,'API svarar.');
  }catch(e){ setStatus(false,String(e)); }
}

/* ===== Poäng ===== */
async function refreshScores(){
  const j = await api('getScores');
  if(!j.ok) return setStatus(false,j.error||'getScores');
  for (const p of PEOPLE){ const el=document.getElementById(`s-${p}`); if(el) el.value=j.scores?.[p] ?? ''; }
  $('#scoresRow').classList.add('flash'); setTimeout(()=>$('#scoresRow').classList.remove('flash'),700);
}
async function saveAllScores(){
  // bygg paket
  const scores={};
  for (const p of PEOPLE){
    const v=(document.getElementById(`s-${p}`)?.value||'').trim();
    if (v!=='') scores[p]=v;
  }
  if (!Object.keys(scores).length) return setStatus(false,'inga poäng ifyllda');
  // 1) försök saveScores (bulk)
  let j = await api('saveScores', {scores: JSON.stringify(scores)});
  // 2) om ok:false/unknown action → spara en och en
  if (!j.ok && /unknown/i.test(j.error||'')){
    const jobs = Object.entries(scores).map(([person,score])=>api('saveScore',{person,score}));
    const all = await Promise.all(jobs);
    j = all.every(x=>x.ok) ? {ok:true} : {ok:false, error:'kunde inte spara alla poäng'};
  }
  if (j.ok){ setStatus(true,'poäng sparade'); await refreshScores(); }
  else setStatus(false, j.error||'saveScores');
}

/* ===== Önskelista (min) ===== */
async function loadMyList(){
  const who = $('#who').value;
  const j = await api('getWishlist',{person:who});
  if (!j.ok) return;
  $('#w1').value=j.R1||''; $('#w2').value=j.R2||''; $('#w3').value=j.R3||''; $('#w4').value=j.R4||''; $('#w5').value=j.R5||'';
}
async function saveMyList(){
  const who = $('#who').value;
  const body={person:who, R1:$('#w1').value, R2:$('#w2').value, R3:$('#w3').value, R4:$('#w4').value, R5:$('#w5').value};
  const j = await api('saveWishlist', body);
  setStatus(j.ok, j.ok?'lista sparad':(j.error||'saveWishlist'));
  if (j.ok) { $('#saveList').classList.add('flash'); setTimeout(()=>$('#saveList').classList.remove('flash'),700); }
}

/* ===== Tur & kväll ===== */
async function skipNext(){
  const j = await api('skipNext');
  setStatus(j.ok, j.ok?(`Tur flyttad – nästa: ${j.next||''}`):(j.error||'skipNext'));
  await loadAll();
}
async function saveNight(){
  const who  = ($('#nextName').value||'').trim();
  const film = ($('#suggested').value||'').trim();
  const comment = ($('#comment').value||'').trim();
  if (!who || !film) return setStatus(false,'saknar “Nästa i tur” eller film');

  const j = await api('saveNight',{who,film,comment});
  if (!j.ok) return setStatus(false, j.error||'saveNight');

  // Skifta önskelistan (#2→#1 etc) för den som valde
  const w = await api('getWishlist',{person:who});
  if (w.ok){
    await api('saveWishlist', {person:who, R1:w.R2||'', R2:w.R3||'', R3:w.R4||'', R4:w.R5||'', R5:''});
  }

  // nollställ poängfält
  for (const p of PEOPLE){ const el=document.getElementById(`s-${p}`); if(el) el.value=''; }
  $('#comment').value='';

  setStatus(true, `Kväll sparad – ny tur: ${j.nextPerson||''}`);
  await loadAll();
}

/* ===== Inställningar/kopplingar ===== */
function bindUI(){
  // personer i select
  $('#who').innerHTML = PEOPLE.map(p=>`<option>${p}</option>`).join('');
  // restore
  const savedPw = localStorage.getItem(LS_PW)||''; if(savedPw) $('#pw').value=savedPw;
  $('#theme').value = localStorage.getItem('film_theme') || 'auto';
  $('#accent').value= localStorage.getItem('film_accent')|| 'gul';
  applyTheme(); applyAccent();

  // events
  $('#togglePw').onclick = ()=>{ const f=$('#pw'); f.type=(f.type==='password'?'text':'password'); $('#togglePw').textContent=(f.type==='password'?'Visa':'Dölj'); };
  $('#savePw').onclick   = async ()=>{ const r = await api('ping'); if(r.ok){ setPw($('#pw').value.trim()); setStatus(true,'lösenord sparat'); } else setStatus(false,r.error||'fel lösen'); };

  $('#theme').onchange = ()=>{ localStorage.setItem('film_theme',$('#theme').value); applyTheme(); };
  $('#accent').onchange= ()=>{ localStorage.setItem('film_accent',$('#accent').value); applyAccent(); };
  $('#who').onchange   = ()=>{ loadMyList(); };

  $('#refreshScores').onclick = refreshScores;
  $('#saveAllScores').onclick = saveAllScores;
  $('#skip').onclick          = skipNext;
  $('#saveNight').onclick     = saveNight;
  $('#loadList').onclick      = loadMyList;
  $('#saveList').onclick      = saveMyList;
}

/* ===== Start ===== */
(async function(){
  bindUI();
  // testkontakt
  try{ const p=await api('ping'); setStatus(!!p.ok, p.ok?'API svarar.':(p.error||'ok=false')); }catch(e){ setStatus(false,String(e)); }
  await loadAll();
})();
</script>
</body>
</html>