<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filmkväll – tur & poäng</title>
  <style>
    :root{
      --bg:#0f1116; --panel:#161a22; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#f6c247; --accent-weak:#ffe399; --ok:#2ea86b; --err:#e5534b;
      --input:#0f1116; --border:#2a3140; --btn:#1f2533; --btn-text:#e6e8ee;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px;}
    h1{font-size:26px; margin:0 0 8px;}
    h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:14px 0;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .col{flex:1 1 220px; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px;}
    input, select, button, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none;
    }
    input::placeholder{color:#7b8597}
    button{
      background:var(--btn); color:var(--btn-text); cursor:pointer; border:1px solid var(--border);
      padding:8px 12px; border-radius:9px; font-size:14px;
    }
    .primary{background:var(--accent); color:#1b1f2a; border-color:#c8a73a}
    .ghost{background:transparent}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:#1e2431; border:1px solid var(--border)}
    .grid5{display:grid; grid-template-columns:repeat(5,1fr); gap:12px}
    .right{margin-left:auto}
    .sep{height:1px; background:var(--border); margin:14px 0}
    .tight{margin-top:6px; margin-bottom:6px}
    .note{font-size:13px; color:var(--muted); margin-top:6px}
    .flash{animation:flash 700ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(246,194,71,.0)}40%{box-shadow:0 0 0 6px rgba(246,194,71,.25)}100%{box-shadow:0 0 0 0 rgba(246,194,71,.0)}}
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --panel:#ffffff; --text:#151823; --muted:#5b6475;
        --accent:#f6c247; --accent-weak:#ffe399; --input:#ffffff; --border:#dfe3ee; --btn:#eef0f6; --btn-text:#111826;
      }
      input,select,textarea{box-shadow:0 0 0 1px var(--border) inset}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Filmkväll – tur & poäng</h1>
    <p class="muted">Välj vem du är, spara lösenord, uppdatera din lista och sätt poäng.</p>

    <!-- Inställningar -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Jag är</label>
          <select id="who"></select>
        </div>
        <div class="col">
          <label>Tema</label>
          <select id="theme">
            <option value="auto">Auto</option>
            <option value="dark">Mörkt</option>
            <option value="light">Ljust</option>
          </select>
        </div>
        <div class="col">
          <label>Färg</label>
          <select id="accent">
            <option value="gul">Gul</option>
            <option value="blå">Blå</option>
            <option value="grön">Grön</option>
            <option value="röd">Röd</option>
          </select>
        </div>
      </div>

      <div class="toolbar tight">
        <div class="col" style="flex:1 1 320px; min-width:280px">
          <label>Lösenord</label>
          <input id="pw" type="password" placeholder="Look4fun" />
        </div>
        <button id="togglePw" class="ghost">Visa</button>
        <button id="savePw" class="ghost">Spara lösenord</button>
        <div id="apiStatus" class="pill right">Init…</div>
      </div>
    </div>

    <!-- På tur nu -->
    <div class="card" id="nowCard">
      <h3>På tur nu</h3>

      <div class="row">
        <div class="col">
          <label>Nästa i tur</label>
          <input id="nextName" type="text" readonly>
        </div>
        <div class="col">
          <label>Film (förslag från #1 i listan)</label>
          <input id="suggested" type="text" readonly>
        </div>
      </div>

      <!-- Poängrad (OVANFÖR knappar) -->
      <div class="row" id="scoresRow">
        <div class="col"><label>Hannah</label><input id="s-Hannah" placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Maria</label><input id="s-Maria"  placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Tuva</label><input id="s-Tuva"   placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Alva</label><input id="s-Alva"   placeholder="–" inputmode="decimal"></div>
        <div class="col"><label>Lars</label><input id="s-Lars"   placeholder="–" inputmode="decimal"></div>
      </div>

      <div class="toolbar tight">
        <button id="refreshScores" class="ghost">Uppdatera poäng</button>
        <button id="saveAllScores" class="primary">Spara poäng</button>
        <span class="right"></span>
        <button id="skip" class="ghost">Hoppa över</button>
      </div>

      <div class="row">
        <div class="col">
          <label>Kommentar</label>
          <input id="comment" placeholder="valfritt">
        </div>
        <div class="col" style="align-self:end">
          <button id="saveNight" class="primary">Spara kväll</button>
        </div>
      </div>
    </div>

    <!-- Min lista -->
    <div class="card">
      <h3>Mina kommande (1–5)</h3>
      <div class="grid5">
        <input id="w1" placeholder="#1 – högst upp">
        <input id="w2" placeholder="#2">
        <input id="w3" placeholder="#3">
        <input id="w4" placeholder="#4">
        <input id="w5" placeholder="#5">
      </div>
      <div class="toolbar tight">
        <button id="loadList" class="ghost">Hämta min lista</button>
        <button id="saveList" class="primary">Spara min lista</button>
      </div>
      <p class="note">När kvällen sparas för den som är på tur flyttas #2–#5 upp (och #1 tas bort).</p>
    </div>

    <!-- Topplistor -->
    <div class="card">
      <h3>Topplistor (topp 5)</h3>
      <div id="tops"></div>
    </div>

    <!-- Historik -->
    <div class="card">
      <h3>Historik (senaste 10)</h3>
      <div id="history"></div>
    </div>
  </div>

<script>
/* ====== KONFIG ====== */
const API = 'https://script.google.com/macros/s/AKfycbzoyrM9jj8lOy-pTmcR4iCWtIL3-YJ2IDLZ5pVV9wgrIMepCBJ_d_F8CARhqGZdnCoWAA/exec';
const PEOPLE = ['Hannah','Maria','Tuva','Alva','Lars'];

/* ====== HJÄLPARE ====== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const LS_KEY_PW = 'film_pw';
function getPw(){ return ($('#pw').value || localStorage.getItem(LS_KEY_PW) || '').trim(); }
function setPw(v){ $('#pw').value = v; localStorage.setItem(LS_KEY_PW, v); }
function setStatus(ok,msg){ const el=$('#apiStatus'); el.textContent = (ok?'OK – ':'Fel – ') + msg; el.className = ok?'ok':'err'; }
function api(action, params={}) {
  const q = new URLSearchParams({ ...params, action, pw: getPw() });
  return fetch(`${API}?${q.toString()}`, { method:'GET' }).then(r=>r.json());
}

/* ====== INIT & UI-KOPPLING ====== */
window.addEventListener('DOMContentLoaded', () => {
  // sätt ev. sparat lösenord i fältet
  const saved = localStorage.getItem(LS_KEY_PW) || '';
  if (saved) $('#pw').value = saved;

  // testa kontakt
  ping();

  // knappar
  $('#btnShowPw')?.addEventListener('click', () => {
    const f = $('#pw');
    f.type = (f.type === 'password') ? 'text' : 'password';
    $('#btnShowPw').textContent = (f.type === 'password') ? 'Visa' : 'Dölj';
  });
  $('#btnSavePw')?.addEventListener('click', savePassword);

  $('#btnUpdateScores')?.addEventListener('click', loadScores);
  $('#btnSaveScores')?.addEventListener('click', saveScores);
  $('#btnSkip')?.addEventListener('click', skipNext);
  $('#btnSaveNight')?.addEventListener('click', saveNight);

  // ladda “på tur”, förslag & poäng
  loadCurrent();
  loadScores();
  // ladda ev. egen önskelista-knappar om du har dem i din HTML...
});

/* ====== FUNKTIONER ====== */
function ping(){
  api('ping')
    .then(j => setStatus(!!j.ok, j.ok ? 'API svarar.' : (j.error||'ok=false')))
    .catch(e => setStatus(false, String(e)));
}

function savePassword(){
  const pw = ($('#pw').value||'').trim();
  if (!pw){ setStatus(false,'ange lösenord'); return; }
  // verifiera mot backend med ping och spara lokalt
  api('ping').then(j=>{
    if (j.ok){ setPw(pw); setStatus(true,'lösenord sparat'); loadCurrent(); loadScores(); }
    else setStatus(false, j.error||'fel lösen');
  }).catch(e=>setStatus(false,String(e)));
}

function loadCurrent(){
  api('getCurrent').then(j=>{
    if (!j.ok) return setStatus(false, j.error||'getCurrent');
    $('#nextName') && ($('#nextName').value = j.next || '');
    $('#suggestion') && ($('#suggestion').value = j.suggestion || '');
  }).catch(e=>setStatus(false,String(e)));
}

function loadScores(){
  api('getScores').then(j=>{
    if (!j.ok) return setStatus(false, j.error||'getScores');
    (PEOPLE||[]).forEach(p=>{
      const el = document.getElementById(`score_${p}`);
      if (el) el.value = (j.scores && j.scores[p]) ? j.scores[p] : '';
    });
    setStatus(true,'poäng hämtade');
  }).catch(e=>setStatus(false,String(e)));
}

function saveScores(){
  const jobs = (PEOPLE||[]).map(p=>{
    const v = (document.getElementById(`score_${p}`)?.value||'').trim();
    if (!v) return Promise.resolve({ok:true,skipped:true});
    return api('saveScore', { person:p, score:v });
  });
  Promise.all(jobs).then(()=>{
    setStatus(true,'poäng sparade'); 
    loadScores();
  }).catch(e=>setStatus(false,String(e)));
}

function skipNext(){
  api('skipNext').then(j=>{
    if (!j.ok) return setStatus(false, j.error||'skipNext');
    setStatus(true, `Tur flyttad – nästa: ${j.next||''}`);
    loadCurrent();
  }).catch(e=>setStatus(false,String(e)));
}

function saveNight(){
  const who = ($('#nextName')?.value||'').trim();
  const film = ($('#suggestion')?.value||'').trim();
  const imdb = ($('#imdb')?.value||'').trim();
  const comment = ($('#comment')?.value||'').trim();
  if (!who || !film) { setStatus(false,'saknar “Nästa i tur” eller film'); return; }
  api('saveNight', { who, film, imdb, comment }).then(j=>{
    if (!j.ok) return setStatus(false, j.error||'saveNight');
    // nollställ poängfält
    (PEOPLE||[]).forEach(p=>{ const el=document.getElementById(`score_${p}`); if(el) el.value=''; });
    $('#imdb') && ($('#imdb').value=''); $('#comment') && ($('#comment').value='');
    setStatus(true, `Kväll sparad – ny tur: ${j.nextPerson||''}`);
    loadCurrent(); loadScores();
  }).catch(e=>setStatus(false,String(e)));
}
</script>
</body>
</html>