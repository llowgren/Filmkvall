<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filmkväll – tur & poäng</title>
  <style>
    :root{
      --bg:#0f1116; --panel:#161a22; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#f6c247; --accent-weak:#ffe399; --ok:#2ea86b; --err:#e5534b;
      --input:#0f1116; --border:#2a3140; --btn:#1f2533; --btn-text:#e6e8ee;
      --pill-bg:#1f2533;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --text:#151823; --muted:#5b6475;
      --input:#ffffff; --border:#dfe3ee; --btn:#eef0f6; --btn-text:#111826;
      --pill-bg:#f1f3f8;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px;}
    h1{font-size:26px; margin:0 0 8px}
    h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:14px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 220px; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    input,select,button,textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none;
    }
    button{background:var(--btn); color:var(--btn-text); cursor:pointer; border:1px solid var(--border); padding:8px 12px; border-radius:9px; font-size:14px}
    .primary{background:var(--accent); color:#1b1f2a; border-color:#c8a73a}
    .ghost{background:transparent}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--pill-bg); border:1px solid var(--border)}
    #apiStatus.pill{padding:8px 12px; display:inline-block; line-height:1.2}
    .right{margin-left:auto}
    .flash{animation:flash 700ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(246,194,71,0)}40%{box-shadow:0 0 0 6px rgba(246,194,71,.25)}100%{box-shadow:0 0 0 0 rgba(246,194,71,0)}}

    /* Mina kommande i kolumn */
    .wishlist-col input{margin-bottom:8px}

    /* Topplistor två kolumner (staplar på mobil) */
    #tops .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    #tops .col{ display:flex; flex-direction:column; gap:6px; }
    @media (max-width:640px){ #tops .row{ grid-template-columns:1fr; } }

    /* ---- OMDb: smal sökknapp & affisch ---- */
.lookup-wrap {
  display:flex;
  gap:6px;
  align-items:center;
}
.lookup-input {
  flex:1 1 auto;
  padding:10px 12px;
}
.lookup-btn {
  flex:0 0 auto;
  padding:6px 8px;
  font-size:12px;
  line-height:1;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--btn);
  color:var(--btn-text);
  cursor:pointer;
}
.omdb-info {
  margin:6px 0 8px;
  font-size:13px;
  color:var(--muted);
  display:flex;
  align-items:flex-start;
  gap:8px;
}
.omdb-info img {
  width:48px;
  height:auto;
  border-radius:6px;
  border:1px solid var(--border);
}
.omdb-info a {
  color:inherit;
  text-decoration:underline;
}

    /* ---- Poäng på en rad ---- */
    #scoresRow{display:flex; gap:8px; align-items:flex-end; flex-wrap:nowrap; overflow:auto; padding-bottom:2px}
    .score-col{min-width:120px; flex:1 1 0}
    .score-col label{margin-bottom:4px}
    .score-col input{padding:8px 10px; border-radius:8px; text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Filmkväll – tur & poäng</h1>
    <p class="muted">Välj vem du är, uppdatera din lista och sätt poäng. Allt sparas i arket.</p>

    <!-- Inställningar -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Jag är</label>
          <select id="who"></select>
        </div>
        <div class="col">
          <label>Tema</label>
          <select id="theme">
            <option value="auto" selected>Auto</option>
            <option value="dark">Mörkt</option>
            <option value="light">Ljust</option>
          </select>
        </div>
        <div class="col">
          <label>Status</label>
          <div id="apiStatus" class="pill">Init…</div>
        </div>
      </div>
    </div>

    <!-- På tur nu -->
    <div class="card" id="nowCard">
      <h3>På tur nu</h3>
      <div class="row">
        <div class="col">
          <label>Nästa i tur</label>
          <input id="nextName" type="text" readonly>
        </div>

        <div class="col">
          <label>Film (förslag från #1 i listan)</label>
          <div class="lookup-wrap">
            <input id="suggested" class="lookup-input" type="text" readonly>
            <button class="lookup-btn" data-lookup="suggested">Sök</button>
          </div>
          <div id="suggested-info" class="omdb-info"></div>
        </div>
      </div>

      <!-- Poäng på en rad -->
      <div id="scoresRow" class="flash">
        <div class="score-col"><label>Hannah</label><input id="s-Hannah" placeholder="–" inputmode="decimal"></div>
        <div class="score-col"><label>Maria</label><input  id="s-Maria"  placeholder="–" inputmode="decimal"></div>
        <div class="score-col"><label>Tuva</label><input   id="s-Tuva"   placeholder="–" inputmode="decimal"></div>
        <div class="score-col"><label>Alva</label><input   id="s-Alva"   placeholder="–" inputmode="decimal"></div>
        <div class="score-col"><label>Lars</label><input   id="s-Lars"   placeholder="–" inputmode="decimal"></div>
      </div>

      <div class="row">
        <button id="refreshScores" class="ghost">Uppdatera poäng</button>
        <button id="saveAllScores" class="primary">Spara poäng</button>
        <span class="right"></span>
        <button id="skip" class="ghost">Hoppa över</button>
      </div>

      <div class="row">
        <div class="col">
          <label>Kommentar</label>
          <input id="comment" placeholder="valfritt">
        </div>
        <div class="col" style="align-self:end">
          <button id="saveNight" class="primary">Spara kväll</button>
        </div>
      </div>
    </div>

    <!-- Min lista -->
    <div class="card">
      <h3>Mina kommande (1–5)</h3>
      <div class="wishlist-col" id="wishlistCol">
        <div class="lookup-wrap"><input id="w1" class="lookup-input" placeholder="#1 – högst upp"><button class="lookup-btn" data-lookup="w1">Sök</button></div>
        <div id="w1-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w2" class="lookup-input" placeholder="#2"><button class="lookup-btn" data-lookup="w2">Sök</button></div>
        <div id="w2-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w3" class="lookup-input" placeholder="#3"><button class="lookup-btn" data-lookup="w3">Sök</button></div>
        <div id="w3-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w4" class="lookup-input" placeholder="#4"><button class="lookup-btn" data-lookup="w4">Sök</button></div>
        <div id="w4-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w5" class="lookup-input" placeholder="#5"><button class="lookup-btn" data-lookup="w5">Sök</button></div>
        <div id="w5-info" class="omdb-info"></div>
      </div>
      <div class="row">
        <button id="loadList" class="ghost">Hämta min lista</button>
        <button id="saveList" class="primary">Spara min lista</button>
      </div>
      <p class="muted">När kvällen sparas för den som är på tur flyttas #2–#5 upp (och #1 tas bort).</p>
    </div>

    <!-- Topplistor -->
    <div class="card">
      <h3>Topplistor (topp 5)</h3>
      <div id="tops"></div>
    </div>

    <!-- Historik -->
    <div class="card">
      <h3>Historik (senaste 10)</h3>
      <div id="history"></div>
    </div>
  </div>

<script>
/* ===== KONFIG ===== */
const API    = 'https://script.google.com/macros/s/AKfycbzoyrM9jj8lOy-pTmcR4iCWtIL3-YJ2IDLZ5pVV9wgrIMepCBJ_d_F8CARhqGZdnCoWAA/exec';
const PEOPLE = ['Hannah','Maria','Tuva','Alva','Lars'];
const PW     = 'Look4fun'; // hårdkodat lösen i frontenden

// OMDb
const OMDB_KEY = 'b6f3e48';              // din nyckel
const OMDB_URL = 'https://www.omdbapi.com/';

/* ===== Hjälpare ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const qs = (o)=> new URLSearchParams(o).toString();
const api = (action, params={}) =>
  fetch(`${API}?${qs({action, pw:PW, ...params})}`, {cache:'no-store'}).then(r=>r.json());
const round1 = (x)=>Math.round((Number(x)||0)*10)/10;
const setStatus=(ok,msg)=>{ const el=$('#apiStatus'); el.textContent=(ok?'OK – ':'Fel – ')+msg; el.className='pill '+(ok?'ok':'err'); };
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===== Tema ===== */
function applyTheme(){
  const sel = $('#theme').value;
  const root = document.documentElement;
  let mode = sel;
  if (sel === 'auto'){
    mode = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  }
  if (mode === 'light') root.setAttribute('data-theme', 'light');
  else root.removeAttribute('data-theme');
  root.style.colorScheme = (mode === 'light') ? 'light' : 'dark';
}
const _mqlLight = window.matchMedia('(prefers-color-scheme: light)');
const _onSchemeChange = () => { if ($('#theme')?.value === 'auto') applyTheme(); };
_mqlLight.addEventListener?.('change', _onSchemeChange);
_mqlLight.addListener?.(_onSchemeChange);

/* ===== OMDb ===== */
async function omdbLookup(query){
  if(!query) return null;
  query = query.trim();
  const tt = (query.match(/tt\d{7,}/i) || query.match(/imdb\.com\/title\/(tt\d+)/i));
  const params = tt ? { i: (tt[1] || tt[0]).replace(/^.*(tt\d+).*$/,'$1') } : { t: query };
  const url = `${OMDB_URL}?apikey=${OMDB_KEY}&plot=short&type=movie&${qs(params)}`;
  try{
    const r = await fetch(url, {cache:'no-store'}); const j = await r.json();
    if(j && j.Response !== 'False') return j;
  }catch(e){/* tyst */}
  return null;
}
function renderOmdbInfo(containerId, data, query){
  const el = document.getElementById(containerId);
  if(!el) return;
  if(!data){
    el.innerHTML = query ? `Hittade inget för “${escapeHtml(query)}”.` : '';
    return;
  }

  const title = escapeHtml(data.Title || '');
  const year  = escapeHtml(data.Year || '');
  const rate  = escapeHtml(data.imdbRating || '-');
  const link  = imdbUrlFrom(data);
  const poster = (data.Poster && data.Poster !== 'N/A') ? `<img src="${data.Poster}" alt="poster">` : '';

  el.innerHTML = `
    ${poster}
    <div>
      <strong>${title}</strong>${year ? ` (${year})` : ''}<br>
      IMDb ${rate}
      ${link ? ` — <a href="${link}" target="_blank" rel="noopener">Öppna på IMDb</a>` : ''}
    </div>`;
}
/* ===== Ladda hel sida ===== */
async function loadAll(){
  const cur = await api('getCurrent');
  if(!cur.ok) return setStatus(false,cur.error||'getCurrent');
  $('#nextName').value  = cur.next || '';
  $('#suggested').value = cur.suggestion || '';

  // poäng
  if (cur.scores){
    for (const p of PEOPLE){
      const el = document.getElementById(`s-${p}`);
      if (el) el.value = cur.scores[p] ?? '';
    }
  }

  // min lista
  await loadMyList();

  // topplistor
  const tops = await api('getTops', {limit:5});
  if (tops.ok){
    const films = (tops.bestFilms||[]).map(x=>`<div class="pill">${x.film} — <strong>${x.avg}</strong> <span class="muted">(${x.who})</span></div>`).join('') || '–';
    const pickers = (tops.bestPickers||[]).map(x=>`<div class="pill">${x.who} — <strong>${x.avg}</strong> <span class="muted">(${x.n} filmer)</span></div>`).join('') || '–';
    $('#tops').innerHTML = `<div class="row"><div class="col"><label>Bästa filmer</label>${films}</div><div class="col"><label>Bästa väljare</label>${pickers}</div></div>`;
  }

  // historik
  const hist = await api('getHistory', {limit:10});
  if (hist.ok){
    const rows = (hist.rows||[]).map(r=>{
      const nums = PEOPLE.map(p=>Number(r[p])||0).filter(x=>x>0);
      const avg = nums.length? round1(nums.reduce((a,b)=>a+b,0)/nums.length) : '-';
      const per = PEOPLE.map(p=>`${p}: ${r[p]||'-'}`).join(' • ');
      return `<div class="pill" style="display:block;margin:6px 0;padding:10px 12px">
        <strong>${r['Film']||'–'}</strong> — ${r['Datum']||''}
        <span class="muted"> (val: ${r['Vem valde']||'-'}, Snitt: ${avg})</span><br/>
        <span class="muted">${per}</span></div>`;
    }).join('');
    $('#history').innerHTML = rows || 'Tomt.';
  }

  // uppdatera OMDb-info för “på tur nu”
  await updateSuggestedInfo();

  setStatus(true,'API svarar.');
}

/* ===== Poäng ===== */
async function refreshScores(){
  const j = await api('getScores');
  if(!j.ok) return setStatus(false,j.error||'getScores');
  for (const p of PEOPLE){
    const el = document.getElementById(`s-${p}`);
    if (el) el.value = j.scores?.[p] ?? '';
  }
  $('#scoresRow').classList.add('flash'); setTimeout(()=>$('#scoresRow').classList.remove('flash'),700);
}
async function saveAllScores(){
  const scores = {};
  for (const p of PEOPLE){
    const v = (document.getElementById(`s-${p}`)?.value || '').toString().trim();
    if (v !== '') scores[p] = v;
  }
  if (!Object.keys(scores).length) return setStatus(false,'inga poäng ifyllda');

  let j = await api('saveScores', {scores: JSON.stringify(scores)});
  if (!j.ok && /unknown/i.test(j.error||'')){
    const jobs = Object.entries(scores).map(([person,score])=> api('saveScore',{person,score}));
    const all = await Promise.all(jobs);
    j = all.every(x=>x.ok) ? {ok:true} : {ok:false, error:'kunde inte spara alla poäng'};
  }
  if (j.ok){ setStatus(true,'poäng sparade'); await refreshScores(); }
  else setStatus(false, j.error||'saveScores');
}

/* ===== Önskelista (min) ===== */
async function loadMyList(){
  const who = $('#who').value;
  const j = await api('getWishlist', {person:who});
  if (!j.ok) return;
  $('#w1').value=j.R1||''; $('#w2').value=j.R2||''; $('#w3').value=j.R3||''; $('#w4').value=j.R4||''; $('#w5').value=j.R5||'';

  // Fyll OMDb-info direkt när listan hämtas
  for (const id of ['w1','w2','w3','w4','w5']){
    const q = document.getElementById(id).value;
    const data = await omdbLookup(q);
    renderOmdbInfo(`${id}-info`, data, q);
  }
}
async function saveMyList(){
  const who = $('#who').value;
  const body = {person:who, R1:$('#w1').value, R2:$('#w2').value, R3:$('#w3').value, R4:$('#w4').value, R5:$('#w5').value};
  const j = await api('saveWishlist', body);
  setStatus(j.ok, j.ok?'lista sparad':(j.error||'saveWishlist'));
}

/* ===== Tur & kväll ===== */
async function skipNext(){
  const j = await api('skipNext');
  setStatus(j.ok, j.ok?(`Tur flyttad – nästa: ${j.next||''}`):(j.error||'skipNext'));
  await loadAll();
}
async function saveNight(){
  const who  = ($('#nextName').value||'').trim();
  const film = ($('#suggested').value||'').trim();
  const comment = ($('#comment').value||'').trim();
  if (!who || !film) return setStatus(false,'saknar “Nästa i tur” eller film');

  const j = await api('saveNight', {who, film, comment});
  if (!j.ok) return setStatus(false, j.error||'saveNight');

  for (const p of PEOPLE){ const el=document.getElementById(`s-${p}`); if(el) el.value=''; }
  $('#comment').value='';
  setStatus(true, `Kväll sparad – ny tur: ${j.nextPerson||''}`);
  await loadAll();
}

/* ===== OMDb UI-bindningar ===== */
function bindLookupUI(){
  // Sök-knappar
  document.querySelectorAll('button[data-lookup]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-lookup');
      const input = document.getElementById(id);
      const infoId = `${id}-info`;
      const q = input?.value || '';
      const data = await omdbLookup(q);
      renderOmdbInfo(infoId, data, q);
    });
  });
  // Enter i fält
  ['w1','w2','w3','w4','w5','suggested'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const q = el.value;
        const data = await omdbLookup(q);
        renderOmdbInfo(`${id}-info`, data, q);
      }
    });
    el.addEventListener('change', async ()=>{
      const q = el.value;
      const data = await omdbLookup(q);
      renderOmdbInfo(`${id}-info`, data, q);
    });
  });
}
async function updateSuggestedInfo(){
  const q = $('#suggested').value || '';
  const data = await omdbLookup(q);
  renderOmdbInfo('suggested-info', data, q);
}

/* ===== Init ===== */
function getParam(name){ return new URLSearchParams(location.search).get(name); }
function bindUI(){
  // personer
  $('#who').innerHTML = PEOPLE.map(p=>`<option>${p}</option>`).join('');

  // default “Jag är”: URL > sparat > Lars
  const urlWho = getParam('who');
  const savedWho = localStorage.getItem('film_who');
  const fallbackWho = 'Lars';
  const initialWho = [urlWho, savedWho, fallbackWho].find(w => PEOPLE.includes(w)) || PEOPLE[0];
  $('#who').value = initialWho;
  if (!savedWho) localStorage.setItem('film_who', initialWho);

  // tema
  $('#theme').value = localStorage.getItem('film_theme') || 'auto';
  applyTheme();
  $('#theme').onchange = ()=>{ localStorage.setItem('film_theme', $('#theme').value); applyTheme(); };

  // händelser
  $('#who').onchange         = ()=>{ localStorage.setItem('film_who', $('#who').value); loadMyList(); };
  $('#refreshScores').onclick= refreshScores;
  $('#saveAllScores').onclick= saveAllScores;
  $('#skip').onclick         = skipNext;
  $('#saveNight').onclick    = saveNight;
  $('#loadList').onclick     = loadMyList;
  $('#saveList').onclick     = saveMyList;
}

(async function(){
  bindUI();
  bindLookupUI();

  try{
    const p = await api('ping');
    setStatus(!!p.ok, p.ok?'API svarar.':(p.error||'ok=false'));
  }catch(e){ setStatus(false, String(e)); }

  await loadAll();
})();
</script>
</body>
</html>