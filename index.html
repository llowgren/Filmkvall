<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filmkväll – tur & poäng</title>
  <style>
    :root{
      --bg:#0f1116; --panel:#161a22; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#f6c247; --accent-weak:#ffe399; --ok:#2ea86b; --err:#e5534b;
      --input:#0f1116; --border:#2a3140; --btn:#1f2533; --btn-text:#e6e8ee;
      --pill-bg:#1f2533;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --text:#151823; --muted:#5b6475;
      --input:#ffffff; --border:#dfe3ee; --btn:#eef0f6; --btn-text:#111826;
      --pill-bg:#f1f3f8;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px;}
    h1{font-size:26px; margin:0 0 8px}
    h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:14px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 220px; min-width:220px}
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none;
    }
    button{
      background:var(--btn); color:var(--btn-text); cursor:pointer;
      border:1px solid var(--border); padding:8px 12px; border-radius:9px; font-size:14px;
    }
    .primary{background:var(--accent); color:#1b1f2a; border-color:#c8a73a}
    .ghost{background:transparent}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-size:13px; background:var(--pill-bg); border:1px solid var(--border)}
    #apiStatus.pill{padding:8px 12px; display:inline-block; line-height:1.2}
    .right{margin-left:auto}
    .flash{animation:flash 700ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(246,194,71,0)}40%{box-shadow:0 0 0 6px rgba(246,194,71,.25)}100%{box-shadow:0 0 0 0 rgba(246,194,71,0)}}

    /* Önskelista i kolumn */
    .wishlist-col input{margin-bottom:8px}

    /* Topplistor i två kolumner (1 kolumn på smal skärm) */
    #tops .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    #tops .col{ display:flex; flex-direction:column; gap:6px; }
    @media (max-width:640px){ #tops .row{ grid-template-columns:1fr; } }

    /* OMDb-sök rader */
    .lookup-wrap{display:flex; gap:6px; align-items:center; flex-wrap:nowrap}
    .lookup-input{flex:1 1 auto; min-width:0; padding:10px 12px}
    .lookup-btn{
      flex:0 0 auto; width:auto; padding:6px 10px; font-size:12px; line-height:1; white-space:nowrap;
      border-radius:8px; border:1px solid var(--border); background:var(--btn); color:var(--btn-text);
    }
    .omdb-info{
      margin:6px 0 8px; font-size:13px; color:var(--muted);
      display:flex; align-items:flex-start; gap:8px;
    }
    .omdb-info img{
      width:64px; height:auto; border-radius:6px; border:1px solid var(--border);
    }
    .omdb-info a{ color:inherit; text-decoration:underline; }
    @media (max-width:520px){
      .lookup-wrap{flex-wrap:wrap}
      .lookup-input{flex-basis:100%}
      .lookup-btn{margin-top:4px}
    }

    /* Poängrad – horisontell scroll om trångt */
    #scoresRow{display:flex; gap:8px; align-items:flex-end; flex-wrap:nowrap; overflow:auto; padding-bottom:2px}
    .score-col{min-width:100px; flex:1 1 0}
    .score-col label{margin-bottom:4px}
    .score-col input{padding:8px 10px; border-radius:8px; text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Filmkväll – tur & poäng</h1>
    <p class="muted">Välj vem du är, uppdatera din lista och sätt poäng. Allt sparas i arket.</p>

    <!-- Inställningar -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Jag är</label>
          <select id="who"></select>
        </div>
        <div class="col">
          <label>Tema</label>
          <select id="theme">
            <option value="auto" selected>Auto</option>
            <option value="dark">Mörkt</option>
            <option value="light">Ljust</option>
          </select>
        </div>
        <div class="col">
          <label>Status</label>
          <div id="apiStatus" class="pill">Init…</div>
        </div>
      </div>
    </div>

    <!-- På tur nu -->
    <div class="card" id="nowCard">
      <h3>På tur nu</h3>
      <div class="row">
        <div class="col">
          <label>Nästa i tur</label>
          <input id="nextName" type="text" readonly>
        </div>
        <div class="col">
          <label>Film (förslag från #1 i listan)</label>
          <div class="lookup-wrap">
            <input id="suggested" class="lookup-input" type="text" readonly>
            <button class="lookup-btn" data-lookup="suggested">Sök</button>
          </div>
          <div id="suggested-info" class="omdb-info"></div>
        </div>
      </div>

      <!-- Poäng -->
  <!-- Poäng -->
<div id="scoresRow">
  <div class="score-col">
    <label>Hannah</label>
    <select id="s-Hannah" class="score-select">
      <option value="">–</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
  </div>

  <div class="score-col">
    <label>Maria</label>
    <select id="s-Maria" class="score-select">
      <option value="">–</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
  </div>

  <div class="score-col">
    <label>Tuva</label>
    <select id="s-Tuva" class="score-select">
      <option value="">–</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
  </div>

  <div class="score-col">
    <label>Alva</label>
    <select id="s-Alva" class="score-select">
      <option value="">–</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
  </div>

  <div class="score-col">
    <label>Lars</label>
    <select id="s-Lars" class="score-select">
      <option value="">–</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
    </select>
  </div>
</div>
      <div class="row">
        <button id="refreshScores" class="ghost">Uppdatera poäng</button>
        <button id="saveAllScores" class="primary">Spara poäng</button>
        <span class="right"></span>
        <button id="skip" class="ghost">Hoppa över</button>
      </div>

      <div class="row">
        <div class="col">
          <label>Kommentar</label>
          <input id="comment" placeholder="valfritt">
        </div>
        <div class="col" style="align-self:end">
          <button id="saveNight" class="primary">Spara kväll</button>
        </div>
      </div>
    </div>

    <!-- Min lista -->
    <div class="card">
      <h3>Mina kommande (1–5)</h3>
      <div class="wishlist-col" id="wishlistCol">
        <div class="lookup-wrap"><input id="w1" class="lookup-input" placeholder="#1 – högst upp"><button class="lookup-btn" data-lookup="w1">Sök</button></div>
        <div id="w1-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w2" class="lookup-input" placeholder="#2"><button class="lookup-btn" data-lookup="w2">Sök</button></div>
        <div id="w2-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w3" class="lookup-input" placeholder="#3"><button class="lookup-btn" data-lookup="w3">Sök</button></div>
        <div id="w3-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w4" class="lookup-input" placeholder="#4"><button class="lookup-btn" data-lookup="w4">Sök</button></div>
        <div id="w4-info" class="omdb-info"></div>

        <div class="lookup-wrap"><input id="w5" class="lookup-input" placeholder="#5"><button class="lookup-btn" data-lookup="w5">Sök</button></div>
        <div id="w5-info" class="omdb-info"></div>
      </div>
      <div class="row">
        <button id="loadList" class="ghost">Hämta min lista</button>
        <button id="saveList" class="primary">Spara min lista</button>
      </div>
      <p class="muted">När kvällen sparas för den som är på tur flyttas #2–#5 upp (och #1 tas bort).</p>
    </div>

    <!-- Topplistor -->
    <div class="card">
      <h3>Topplistor (topp 5)</h3>
      <div id="tops"></div>
    </div>

    <!-- Historik -->
    <div class="card">
      <h3>Historik (senaste 10)</h3>
      <div id="history"></div>
    </div>
  </div>

<script>
/* ===== KONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycby82y98CZDZc4d9tSdyi-dovoHf84sx4LC0RLQ-SosU44_BlNPzhsqWhqkNHU5Vsw7hrA/exec';
const PEOPLE = ['Hannah','Maria','Tuva','Alva','Lars'];
const PW     = 'Look4fun';

// OMDb
const OMDB_KEY = 'b6f3e48';
const OMDB_URL = 'https://www.omdbapi.com/';

// Watchmode (Sverige + ingår)
const WATCHMODE_KEY = '6fs0TqcE6LrZttIvVKKJ1Heg97B161Ay1HntH9Vq';
const WATCHMODE_URL = 'https://api.watchmode.com/v1/title/';

/* ===== Hjälpare ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const qs = (o)=> new URLSearchParams(o).toString();
const api = (action, params={}) =>
  fetch(`${API}?${qs({action, pw:PW, ...params})}`, {cache:'no-store'}).then(r=>r.json());
const round1 = (x)=>Math.round((Number(x)||0)*10)/10;
const setStatus=(ok,msg)=>{ const el=$('#apiStatus'); el.textContent=(ok?'OK – ':'Fel – ')+msg; el.className='pill '+(ok?'ok':'err'); };
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
/* ===== Watchmode-ID cache ===== */
const _wmIdCache = new Map();
async function getWmIdCached(imdbID){
  if(_wmIdCache.has(imdbID)) return _wmIdCache.get(imdbID);
  const id = await wmTitleIdFromImdb(imdbID);
  _wmIdCache.set(imdbID, id);
  return id;
}
/* ===== Tema (Auto/Ljust/Mörkt) ===== */
function applyTheme(){
  const sel = $('#theme').value;
  const root = document.documentElement;
  let mode = sel;
  if (sel === 'auto'){
    mode = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  }
  if (mode === 'light') root.setAttribute('data-theme', 'light');
  else root.removeAttribute('data-theme');
  root.style.colorScheme = (mode === 'light') ? 'light' : 'dark';
}
const _mqlLight = window.matchMedia('(prefers-color-scheme: light)');
const _onSchemeChange = () => { if ($('#theme')?.value === 'auto') applyTheme(); };
_mqlLight.addEventListener?.('change', _onSchemeChange);
_mqlLight.addListener?.(_onSchemeChange);

/* ===== OMDb ===== */
function imdbUrlFrom(j){ return j?.imdbID ? `https://www.imdb.com/title/${j.imdbID}/` : ''; }
function norm(s){ return String(s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }

async function omdbLookup(query){
  if(!query) return null;
  let q = query.trim(), year = null;
  const mYear = q.match(/\((\d{4})\)$/);
  if(mYear){ year = mYear[1]; q = q.replace(/\s*\(\d{4}\)\s*$/,''); }

  const tt = (q.match(/tt\d{7,}/i) || q.match(/imdb\.com\/title\/(tt\d+)/i));
  if(tt){
    const id = (tt[1] || tt[0]).replace(/^.*(tt\d+).*$/,'$1');
    const r = await fetch(`${OMDB_URL}?apikey=${OMDB_KEY}&i=${id}&plot=short`,{cache:'no-store'}).catch(()=>null);
    const j = r? await r.json():null;
    if(j && j.Response!=='False') return j;
    return null;
  }

  try{
    const r1 = await fetch(`${OMDB_URL}?apikey=${OMDB_KEY}&t=${encodeURIComponent(q)}${year?`&y=${year}`:''}&type=movie&plot=short`,{cache:'no-store'});
    const j1 = await r1.json();
    if(j1 && j1.Response!=='False') return j1;
  }catch(_){}
  try{
    const r2 = await fetch(`${OMDB_URL}?apikey=${OMDB_KEY}&s=${encodeURIComponent(q)}&type=movie`,{cache:'no-store'});
    const j2 = await r2.json();
    if(j2 && j2.Response!=='False' && Array.isArray(j2.Search) && j2.Search.length){
      const nq = norm(q);
      const scored = j2.Search
        .map(it=>({ it, nt:norm(it.Title), y:it.Year }))
        .map(o=>{
          let score = 0;
          if(o.nt === nq) score = 3;
          else if(o.nt.startsWith(nq)) score = 2;
          else if(o.nt.includes(nq)) score = 1;
          if(year && String(o.y) === String(year)) score += 0.5;
          return {score, it:o.it};
        })
            .sort((a,b)=> b.score - a.score);
      return scored[0]?.it ? await omdbLookup(scored[0].it.Title) : null;
    }
  }catch(_){}
  return null;
}
// Slå upp Watchmode-ID från IMDb-ID (robust: find -> fallback search)
async function wmTitleIdFromImdb(imdbID){
  try{
    const u1 = `https://api.watchmode.com/v1/find/?apiKey=${WATCHMODE_KEY}&source=imdb&external_id=${encodeURIComponent(imdbID)}`;
    let r = await fetch(u1, {cache:'no-store'});
    if(r.ok){
      const j = await r.json();
      if(j && j.title_id) return j.title_id;
    }
    const u2 = `https://api.watchmode.com/v1/search/?apiKey=${WATCHMODE_KEY}&search_field=imdb_id&search_value=${encodeURIComponent(imdbID)}`;
    r = await fetch(u2, {cache:'no-store'});
    if(r.ok){
      const j = await r.json();
      const hit = Array.isArray(j?.title_results) ? j.title_results.find(t => String(t.imdb_id) === String(imdbID)) : null;
      if(hit?.id) return hit.id;
    }
  }catch(_){}
  return null;
}
/* ===== Watchmode – slå först upp Watchmode-ID från IMDb-ID ===== */
async function getStreamingInfo(imdbID) {
  if (!imdbID) return null;
  try {
    const wmId = await getWmIdCached(imdbID);
    if (!wmId) return null;

    // Hämta alla regioner (ingen regionsbegränsning)
    const url = `https://api.watchmode.com/v1/title/${wmId}/sources/?apiKey=${WATCHMODE_KEY}`;
    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json();
    if (!Array.isArray(data)) return null;

    const seen = new Set();
    const normalizeName = s => String(s || '')
      .replace(/\s*\(with Ads\)$/i, '')
      .replace(/\s+HD$/, '')
      .trim();

    // Ta bara med de där filmen ingår i abonnemanget (type=sub)
    const filtered = data
      .filter(s => s.type === 'sub' && s.name)
      .map(s => ({
        service: normalizeName(s.name),
        quality: (s.format === '4K' || s.format === 'HD') ? s.format : '',
        region: s.region || '',
        link: s.web_url || ''
      }))
      .filter(s => {
        const key = `${s.service}|${s.quality}|${s.region}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      })
      .sort((a, b) => (a.service + a.region + a.quality).localeCompare(b.service + b.region + b.quality));

    return filtered.length ? filtered : null;
  } catch (e) {
    console.error('Watchmode sources error:', e);
    return null;
  }
}
/* ===== Rendera OMDb + streaming ===== */
async function renderOmdbInfo(containerId, data, query) {
  const el = document.getElementById(containerId);
  if(!el) return;

  if(!data){
    el.innerHTML = `<div style="color:var(--muted)">Hittade inget för: ${escapeHtml(query||'')}</div>`;
    return;
  }

  const title  = escapeHtml(data.Title || '');
  const year   = escapeHtml(data.Year || '');
  const rating = escapeHtml(data.imdbRating || '-');
  const link   = imdbUrlFrom(data);
  const poster = (data.Poster && data.Poster !== 'N/A')
    ? `<img src="${data.Poster}" alt="poster">`
    : '';

  let streamingHtml = '';
  if (data.imdbID) {
    const options = await getStreamingInfo(data.imdbID);
    if (options && options.length > 0) {
      const pills = options.map(opt => {
        const label = [
          opt.service,
          opt.quality ? ` ${opt.quality}` : '',
          opt.region ? ` · ${opt.region}` : ''
        ].join('');
        const href = opt.link
          ? `href="${opt.link}" target="_blank" rel="noopener"`
          : '';
        return `<a ${href} class="pill" style="margin:2px; text-decoration:none">${label} (ingår)</a>`;
      }).join('');
      streamingHtml = `<div style="margin-top:8px">
        <strong>Tillgängligt i abonnemang (globalt):</strong><br>${pills}
      </div>`;
    } else {
      streamingHtml = `<div style="margin-top:6px; color:var(--muted); font-size:12px">
        Inget abonnemang hittades just nu.
      </div>`;
    }
  }

  el.innerHTML = `
    ${poster}
    <div>
      <strong>${title}</strong>${year ? ` (${year})` : ''}<br>
      IMDb ${rating}${link ? ` — <a href="${link}" target="_blank" rel="noopener">Öppna på IMDb</a>` : ''}
      ${streamingHtml}
    </div>`; 
}
/* ===== Ladda allt ===== */ 
async function loadAll(){
  try {
    const now = new Date().toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'});
    const cur = await api('getCurrent');
    if(!cur.ok) return setStatus(false,cur.error||'getCurrent');

    $('#nextName').value  = cur.next || '';
    $('#suggested').value = cur.suggestion || '';

    if (cur.scores){
      for (const p of PEOPLE){
        const el = document.getElementById(`s-${p}`);
        if (el) el.value = cur.scores[p] ?? '';
      }
    }

    // Mina kommande
    try {
      await loadMyList();
    } catch(err) {
      console.error('Fel i loadMyList:', err);
      setStatus(false, 'kunde inte hämta önskelistan');
    }

    // Topplistor
    try {
      const tops = await api('getTops', {limit:5});
      if (tops.ok){
        const films = (tops.bestFilms||[]).map(x=>`<div class="pill">${x.film} — <strong>${x.avg}</strong> <span class="muted">(${x.who})</span></div>`).join('') || '–';
        const pickers = (tops.bestPickers||[]).map(x=>`<div class="pill">${x.who} — <strong>${x.avg}</strong> <span class="muted">(${x.n} filmer)</span></div>`).join('') || '–';
        $('#tops').innerHTML = `<div class="row"><div class="col"><label>Bästa filmer</label>${films}</div><div class="col"><label>Bästa väljare</label>${pickers}</div></div>`;
      } else {
        $('#tops').innerHTML = '<div class="muted">Kunde inte hämta topplistor.</div>';
      }
    } catch(err) {
      console.error('Fel i topplistor:', err);
      $('#tops').innerHTML = '<div class="muted">Kunde inte hämta topplistor.</div>';
    }

    // Historik
    try {
      const hist = await api('getHistory', {limit:10});
      if (hist.ok){
        const rows = (hist.rows||[]).map(r=>{
          const nums = PEOPLE.map(p=>Number(r[p])||0).filter(x=>x>0);
          const avg = nums.length? round1(nums.reduce((a,b)=>a+b,0)/nums.length) : '-';
          const per = PEOPLE.map(p=>`${p}: ${r[p]||'-'}`).join(' • ');
          return `<div class="pill" style="display:block;margin:6px 0;padding:10px 12px">
            <strong>${r['Film']||'–'}</strong> — ${r['Datum']||''}
            <span class="muted"> (val: ${r['Vem valde']||'-'}, Snitt: ${avg})</span><br/>
            <span class="muted">${per}</span></div>`;
        }).join('');
        $('#history').innerHTML = rows || 'Tomt.';
      } else {
        $('#history').innerHTML = '<div class="muted">Kunde inte hämta historik.</div>';
      }
    } catch(err) {
      console.error('Fel i historik:', err);
      $('#history').innerHTML = '<div class="muted">Kunde inte hämta historik.</div>';
    }

    // OMDb för "På tur nu"
    try {
      await updateSuggestedInfo();
    } catch(err) {
      console.error('Fel i updateSuggestedInfo:', err);
    }

    setStatus(true, `API svarar – uppdaterat ${now}`);
  } catch (err) {
    console.error('Fel i loadAll:', err);
    setStatus(false, 'Fel vid laddning');
  }
}
/* ===== Poäng, lista, tur ===== */
async function refreshScores(){
  const j = await api('getScores');
  if(!j.ok) return setStatus(false, j.error || 'getScores');
  for (const p of PEOPLE) {
    const el = document.getElementById(`s-${p}`);
    if (el) el.value = j.scores?.[p] ?? '';
  }
  const row = document.getElementById('scoresRow');
  row?.classList.add('flash');
  setTimeout(()=>row?.classList.remove('flash'), 700);
}

async function saveAllScores(){
  const scores = {};
  for (const p of PEOPLE){
    const v = (document.getElementById(`s-${p}`)?.value || '').trim();
    if (v !== '') scores[p] = v;
  }
  if (!Object.keys(scores).length) {
  setStatus(false, 'inga nya poäng ifyllda');
  return;
}
  const j = await api('saveScores', { scores: JSON.stringify(scores) });
  setStatus(j.ok, j.ok ? 'poäng sparade' : (j.error || 'saveScores'));
  if (j.ok) await refreshScores();
}

/* ===== Önskelista (min) ===== */
async function loadMyList(){
  const who = document.getElementById('who').value;
  const j = await api('getWishlist', { person: who });
  if(!j.ok){ setStatus(false, j.error || 'getWishlist'); return; }

  document.getElementById('w1').value = j.R1 || '';
  document.getElementById('w2').value = j.R2 || '';
  document.getElementById('w3').value = j.R3 || '';
  document.getElementById('w4').value = j.R4 || '';
  document.getElementById('w5').value = j.R5 || '';

  // uppdatera OMDb-rutor
  for (let i=1;i<=5;i++){
    const q = document.getElementById(`w${i}`).value;
    const data = await omdbLookup(q);
    await renderOmdbInfo(`w${i}-info`, data, q);
  }
}

async function saveMyList(){
  const who = document.getElementById('who').value;
  const body = {
    person: who,
    R1: document.getElementById('w1').value,
    R2: document.getElementById('w2').value,
    R3: document.getElementById('w3').value,
    R4: document.getElementById('w4').value,
    R5: document.getElementById('w5').value,
  };
  const j = await api('saveWishlist', body);
  setStatus(j.ok, j.ok ? 'lista sparad' : (j.error || 'saveWishlist'));
  if (j.ok){
    const box = document.getElementById('wishlistCol');
    box?.classList.add('flash');
    setTimeout(()=>box?.classList.remove('flash'), 700);
  }
}

async function skipNext(){
  const j = await api('skipNext');
  setStatus(j.ok, j.ok ? (`Tur flyttad – nästa: ${j.next||''}`) : (j.error || 'skipNext'));
  if (j.ok) await loadAll();
}

async function saveNight(){
  const who = (document.getElementById('nextName').value || '').trim();
  const film = (document.getElementById('suggested').value || '').trim();
  const comment = (document.getElementById('comment').value || '').trim();
  if (!who || !film) return setStatus(false,'saknar “Nästa i tur” eller film');

  const j = await api('saveNight', { who, film, comment });
  setStatus(j.ok, j.ok ? (`Kväll sparad – ny tur: ${j.nextPerson||''}`) : (j.error || 'saveNight'));
  if (j.ok) await loadAll();
}
// --- Bindningar för OMDb-knappar och fält ---
function bindLookupUI(){
  document.querySelectorAll('button[data-lookup]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-lookup');          // t.ex. 'w1' eller 'suggested'
      const q  = document.getElementById(id)?.value || '';
      const data = await omdbLookup(q);
      renderOmdbInfo(`${id}-info`, data, q);
    });
  });

  // Enter/ändring i inmatningsfält => uppdatera infobox
  ['w1','w2','w3','w4','w5','suggested'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        const data = await omdbLookup(el.value);
        renderOmdbInfo(`${id}-info`, data, el.value);
      }
    });
    el.addEventListener('change', async ()=>{
      const data = await omdbLookup(el.value);
      renderOmdbInfo(`${id}-info`, data, el.value);
    });
  });
}

async function updateSuggestedInfo(){
  const q = document.getElementById('suggested').value || '';
  const data = await omdbLookup(q);
  renderOmdbInfo('suggested-info', data, q);
}

// --- UI-bindningar, tema och start ---
function getParam(name){ return new URLSearchParams(location.search).get(name); }

function bindUI(){
  // personer
  document.getElementById('who').innerHTML = PEOPLE.map(p=>`<option>${p}</option>`).join('');
  const urlWho = getParam('who');
  const savedWho = localStorage.getItem('film_who');
  const fallbackWho = 'Lars';
  const initialWho = [urlWho, savedWho, fallbackWho].find(w => PEOPLE.includes(w)) || PEOPLE[0];
  document.getElementById('who').value = initialWho;
  if (!savedWho) localStorage.setItem('film_who', initialWho);

  // tema
  document.getElementById('theme').value = localStorage.getItem('film_theme') || 'auto';
  applyTheme();
  document.getElementById('theme').onchange = ()=>{
    localStorage.setItem('film_theme', document.getElementById('theme').value);
    applyTheme();
  };

  // knappar
  document.getElementById('who').onchange         = ()=>{ localStorage.setItem('film_who', document.getElementById('who').value); loadMyList(); };
  document.getElementById('refreshScores').onclick= refreshScores;
  document.getElementById('saveAllScores').onclick= saveAllScores;
  document.getElementById('skip').onclick         = skipNext;
  document.getElementById('saveNight').onclick    = saveNight;
  document.getElementById('loadList').onclick     = loadMyList;
  document.getElementById('saveList').onclick     = saveMyList;

  // direkt-spara poäng vid val
  document.querySelectorAll('.score-select').forEach(sel=>{
    sel.addEventListener('change', async ()=>{
      const who = sel.id.replace('s-','');
      const val = sel.value.trim();
      if (!val) return;
      const j = await api('saveScores', { scores: JSON.stringify({ [who]: val }) });
      setStatus(j.ok, j.ok ? `poäng sparad för ${who}` : (j.error || 'saveScores'));
      if (j.ok) await refreshScores();
    });
  });
}

// --- Starta appen ---
(async function(){
  bindUI();
  bindLookupUI();
  try{
    const p = await api('ping');
    setStatus(!!p.ok, p.ok ? 'API svarar.' : (p.error || 'ok=false'));
  }catch(e){
    setStatus(false, String(e));
  }
  await loadAll();
})();
</script>
</body>
</html>